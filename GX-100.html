<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GX100 Configuration page</title>

<style>
body {
    background: #1e1e1e;
    font-family: Arial, sans-serif;
    color: #fff;
}

.container {
    width: 900px;
    margin: 20px auto;
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    position: relative;
}

.content {
    position: relative;
}

.overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: 8px;
}

.overlay span {
    font-size: 18px;
    color: #ccc;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

button {
    padding: 6px 14px;
    background: #3cb371;
    border: none;
    color: #000;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    min-width: 140px;
    white-space: nowrap;
}

button:disabled {
    background: #666;
    cursor: not-allowed;
}

.section {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 20px;
}

.shifter-container {
    background: #333;
    padding: 15px;
    border-radius: 6px;
}

.shifter-container h3 {
    margin-top: 0;
    text-align: center;
}


.shifter-layout {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    grid-template-areas:
      "gear-box gear-box gear-box"
      "  empty   h-adj    empty  "
      "gear-box gear-box gear-box";
    gap: 12px;
}

.seq-layout {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    grid-template-areas:
        "gear-box"
        "seq-adj"
        "gear-box";
    gap: 12px;
}

.buttons-layout {
    display: grid;
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr 1fr 1fr 1fr;
    grid-template-areas:
        "gear-box"
        "gear-box"
        "gear-box"
        "gear-box"
        "gear-box";
    gap: 12px;
}

.gear-box {
    background: #1e1e1e;
    border: 2px solid #444;
    border-radius: 4px;
    padding: 12px;
    text-align: center;
    font-weight: bold;
    color: #888;
}

.gear-box.active {
    border-color: #3cb371;
    color: #3cb371;
    background: #1a2d1a;
}

.gear-label {
    font-size: 24px;
    color: #666;
    margin-bottom: 4px;
}

.gear-value {
    font-size: 12px;
}

.h-calibration {
    grid-area: h-shifter;
    background: #1e1e1e;
    border: 2px solid #444;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.h-adj-value {
    grid-area: h-adj;
    background: #1e1e1e;
    border: 2px solid #444;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.seq-calibration {
    grid-area: seq-btn;
    background: #1e1e1e;
    border: 2px solid #444;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.seq-adj-value {
    grid-area: seq-adj;
    background: #1e1e1e;
    border: 2px solid #444;
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.h-calibration button,
.seq-calibration button {
    padding: 8px;
    margin-bottom: 8px;
    font-size: 12px;
}

.h-adj-value label,
.seq-adj-value label {
    font-size: 12px;
    color: #aaa;
    margin-bottom: 6px;
}

.h-adj-value input,
.seq-adj-value input {
    width: 60px;
}


.footer {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #333;
    padding: 15px;
    border-radius: 6px;
}

.checks label {
    margin-right: 20px;
}

.footer button {
    margin-left: 10px;
}
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <div>
            <h2>GX100</h2>
            <span id="deviceName" style="font-size: 12px; color: #aaa; margin-left: 10px;">Not connected</span>
        </div>
        <button id="bindBtn">Bind Device</button>
    </div>

    <div class="content">
        <div id="overlay" class="overlay">
            <span>Please bind device</span>
        </div>

        <div class="section">
            <div class="shifter-container">
                <h3>H Shifter (6-Gear)</h3>
                <div class="shifter-layout">
                    <div class="gear-box">
                        <div class="gear-label">1</div>
                        <div class="gear-value" id="gear1">—</div>
                    </div>

                    <div class="gear-box">
                        <div class="gear-label">3</div>
                        <div class="gear-value" id="gear3">—</div>
                    </div>

                    <div class="gear-box">
                        <div class="gear-label">5</div>
                        <div class="gear-value" id="gear5">—</div>
                    </div>
                    <div class="empty"></div>
                    <div class="h-adj">
                        <div class="h-calibration">
                            <button id="hSetBtn">Start calibration</button>
                        </div>

                        <div class="h-adj-value">
                            <label for="hAdj">Sensitivity</label>
                            <input id="hAdj" type="number" min="0" max="255">
                        </div>
                    </div>
                    <div class="empty"></div>
                    <div class="gear-box">
                        <div class="gear-label">2</div>
                        <div class="gear-value" id="gear2">—</div>
                    </div>

                    <div class="gear-box">
                        <div class="gear-label">4</div>
                        <div class="gear-value" id="gear4">—</div>
                    </div>

                    <div class="gear-box">
                        <div class="gear-label">6</div>
                        <div class="gear-value" id="gear6">—</div>
                    </div>
                </div>
            </div>

            <div class="shifter-container">
                <h3>Sequential Shifter</h3>
                <div class="seq-layout">
                    <div class="gear-box seq-down">
                        <div class="gear-label">Shift -</div>
                        <div class="gear-value" id="seqGear2">—</div>
                    </div>
                    <div class="seq-adj">
                        <div class="seq-calibration">
                            <button id="seqSetBtn">Start calibration</button>
                        </div>

                        <div class="seq-adj-value">
                            <label for="seqAdj">Sensitivity</label>
                            <input id="seqAdj" type="number" min="0" max="255">
                        </div>
                    </div>
                    <div class="gear-box seq-up">
                        <div class="gear-label">Shift +</div>
                        <div class="gear-value" id="seqGear1">—</div>
                    </div>
                </div>
            </div>

            <div class="shifter-container">
                <h3>Buttons</h3>
                <div class="buttons-layout">
                    <div class="gear-box">
                        <div class="gear-label" id="but1">1</div>
                    </div>
                    <div class="gear-box">
                        <div class="gear-label" id="but2">2</div>
                    </div>
                    <div class="gear-box">
                        <div class="gear-label" id="but3">3</div>
                    </div>
                    <div class="gear-box">
                        <div class="gear-label" id="but4">4</div>
                    </div>
                    <div class="gear-box">
                        <div class="gear-label" id="but5">5</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="checks">
                <label><input id="cb1" type="checkbox"> Comb.Switch 1</label>
                <label><input id="cb2" type="checkbox"> Comb.Switch 2</label>
                <label><input id="cbPull" type="checkbox"> Pull Button</label>
                <label><input id="cbSeq" type="checkbox"> Sequential mode</label>
            </div>
            <button id="applyBtn">Apply</button>
        </div>
    </div>
</div>

<script>
let device = null;
let hCalibrating = false;
let seqCalibrating = false;

const overlay = document.getElementById("overlay");
const hBtn = document.getElementById("hSetBtn");
const seqBtn = document.getElementById("seqSetBtn");

/* ---------- UI lock ---------- */
function lockUI(locked) {
    overlay.style.display = locked ? "flex" : "none";
}

/* ---------- Elements ---------- */
const settings = {
    hAdj: document.getElementById("hAdj"),
    seqAdj: document.getElementById("seqAdj"),
    cb1: document.getElementById("cb1"),
    cb2: document.getElementById("cb2"),
    cbPull: document.getElementById("cbPull"),
    cbSeq: document.getElementById("cbSeq")
};

const gearDisplays = {
    1: document.getElementById("gear1"),
    2: document.getElementById("gear2"),
    3: document.getElementById("gear3"),
    4: document.getElementById("gear4"),
    5: document.getElementById("gear5"),
    6: document.getElementById("gear6")
};

const seqGearDisplays = {
    1: document.getElementById("seqGear1"),
    2: document.getElementById("seqGear2")
};

const buttonDisplays = {
    1: document.getElementById("but1"),
    2: document.getElementById("but2"),
    3: document.getElementById("but3"),
    4: document.getElementById("but4"),
    5: document.getElementById("but5")
};

/* ---------- Defaults ---------- */
function applyDefaults() {
    settings.hAdj.value = 80;
    settings.seqAdj.value = 80;
    settings.cb1.checked = true;
    settings.cb2.checked = false;
    settings.cbPull.checked = false;
    settings.cbSeq.checked = false;
}

/* ---------- Persistence ---------- */
function loadSettings() {
    applyDefaults();

    for (const [key, el] of Object.entries(settings)) {
        const v = localStorage.getItem(key);
        if (v === null) continue;

        el.type === "checkbox"
            ? el.checked = (v === "1")
            : el.value = v;
    }
}

function saveSetting(key, el) {
    localStorage.setItem(
        key,
        el.type === "checkbox" ? (el.checked ? "1" : "0") : el.value
    );
}

for (const [key, el] of Object.entries(settings)) {
    el.addEventListener("change", () => saveSetting(key, el));
}

loadSettings();

/* ---------- Device persistence ---------- */
function saveLastDevice(dev) {
    try {
        const deviceInfo = {
            productName: dev.productName,
            vendorId: dev.vendorId,
            productId: dev.productId
        };
        localStorage.setItem('lastConnectedDevice', JSON.stringify(deviceInfo));
        console.log(`[HID] Saved last device: ${dev.productName}`);
    } catch (e) {
        console.error(`[HID] Failed to save device to localStorage:`, e);
    }
}

function getLastDevice() {
    try {
        const saved = localStorage.getItem('lastConnectedDevice');
        if (saved) {
            return JSON.parse(saved);
        }
    } catch (e) {
        console.error(`[HID] Failed to retrieve device from localStorage:`, e);
    }
    return null;
}

async function connectToDevice(dev) {
    console.log(`[HID] Attempting to connect to: ${dev.productName}`);
    
    let connected = false;
    try {
        await dev.open();
        connected = true;
    } catch (openError) {
        console.warn(`[HID] Failed to open device:`, openError.message);
    }
    
    if (connected) {
        dev.addEventListener('inputreport', handleInputReport);
        
        document.getElementById('deviceName').textContent = `Connected: ${dev.productName}`;
        console.log(`[HID] Connected to device: ${dev.productName}`);

        saveLastDevice(dev);
        device = dev;

        lockUI(false);
    } else {
        lockUI(true);
        alert("Failed to connect to device: " + e.message);
    }
}

/* ---------- Auto-connect on page load ---------- */
async function autoConnectDevice() {
    try {
        const devices = await navigator.hid.getDevices();
        console.log(`[HID] Found ${devices.length} device(s)`);
        
        if (devices.length === 0) {
            console.log(`[HID] No devices found`);
            return;
        }
        
        const lastDevice = getLastDevice();
        let targetDevice = null;
        
        if (lastDevice) {
            /* Try to find the last connected device */
            targetDevice = devices.find(d => 
                d.productName === lastDevice.productName &&
                d.vendorId === lastDevice.vendorId &&
                d.productId === lastDevice.productId
            );
            
            if (targetDevice) {
                console.log(`[HID] Found last connected device: ${targetDevice.productName}`);
            } else {
                console.log(`[HID] Last connected device not found in remembered devices`);
            }
        }
        
        if (targetDevice) {
            await connectToDevice(targetDevice);
        }
    } catch (e) {
        console.error(`[HID] Auto-connect failed:`, e);
    }
}

/* Auto-connect when page loads */
window.addEventListener('load', autoConnectDevice);


async function bindDevice() {
    if(device) {
        await device.close();
        device = null;
    }
    const devices = await navigator.hid.requestDevice({
        filters: [{ vendorId: 0x04b0, productId: 0x5750 }]
    });

    if (!devices.length)
        return;

    await connectToDevice(devices[0]);
}

function isPressed(buttonBits, buttonNum) {
    return (buttonBits & (1 << (buttonNum - 1))) !== 0;
}

function handleInputReport(event) {
    const report = new Uint8Array(event.data.buffer);
    
    if (report.length >= 2) {
        const buttonBits = (report[1] << 8) | report[0];
        /*
        ordering is gears 1-8 are buttons 1-8, then seq -/+, then reverse
        Pull ring and shifting into 1 emits a distinct button 11 for reverse
        Same with gears 5/6 with pull ring emits 7/8
        15 is pull ring button if enabled
        */

        // Update gearDisplays:
        gearDisplays[1].parentElement.classList.toggle('active', isPressed(buttonBits, 1) || isPressed(buttonBits, 11));
        gearDisplays[1].parentElement.querySelector('.gear-label').textContent = isPressed(buttonBits, 11) ? 'R' : '1';
        
        gearDisplays[2].parentElement.classList.toggle('active', isPressed(buttonBits, 2));
        gearDisplays[3].parentElement.classList.toggle('active', isPressed(buttonBits, 3));
        gearDisplays[4].parentElement.classList.toggle('active', isPressed(buttonBits, 4));
       
        gearDisplays[5].parentElement.classList.toggle('active', isPressed(buttonBits, 5) || isPressed(buttonBits, 7));
        gearDisplays[5].parentElement.querySelector('.gear-label').textContent = isPressed(buttonBits, 7) ? '7' : '5';

        gearDisplays[6].parentElement.classList.toggle('active', isPressed(buttonBits, 6) || isPressed(buttonBits, 8));
        gearDisplays[6].parentElement.querySelector('.gear-label').textContent = isPressed(buttonBits, 8) ? '8' : '6';


        // Update seqDisplays:
        seqGearDisplays[2].parentElement.classList.toggle('active', isPressed(buttonBits, 9))
        seqGearDisplays[1].parentElement.classList.toggle('active', isPressed(buttonBits, 10))

        // Update buttonDisplays:
        for (let i = 12; i <= 16; i++) {
            gearBox = buttonDisplays[i - 11].parentElement;
            if (gearBox) {
                gearBox.classList.toggle('active', isPressed(buttonBits, i));
            }
        }
    }
    
    /* Parse sensor values */
    if (report.length >= 14) {
        for (let i = 1; i <= 6; i++) {
            const byteOffset = 3 + (i - 1) * 2;
            const sensorValue = (report[byteOffset] << 8) | report[byteOffset + 1];
            if (gearDisplays[i]) {
                gearDisplays[i].textContent = sensorValue.toString();
            }
        }
        
        if (seqGearDisplays[2]) { /* Shift - maps to gear 3 */
            seqGearDisplays[2].textContent = gearDisplays[3].textContent;
        }
        if (seqGearDisplays[1]) { /* Shift + maps to gear 4 */
            seqGearDisplays[1].textContent = gearDisplays[4].textContent;
        }
    }
}

function sendReport(data) {
    if (device) {
        try {
            /* Convert data to hex string for logging */
            const hexString = Array.from(data)
                .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                .join(' ');
            
            console.log(`[HID] Sending report ID: 0, Data (${data.length} bytes):`);
            console.log(`[HID] ${hexString}`);
            
            device.sendReport(0, data);
            console.log(`[HID] Report sent successfully`);
        } catch (e) {
            console.error(`[HID] Error sending report:`, e);
        }
    } else {
        console.warn(`[HID] Device not connected, cannot send report`);
    }
}

/* ---------- Calibration ---------- */
function toggleHCalibration() {
    const r = new Uint8Array(64);
    r[0] = 0x01;
    r[1] = hCalibrating ? 0x02 : 0x01;
    sendReport(r);

    hCalibrating = !hCalibrating;
    hBtn.textContent = hCalibrating ? "Finish" : "Start calibration";
    seqBtn.disabled = hCalibrating;
}

function toggleSeqCalibration() {
    const r = new Uint8Array(64);
    r[0] = 0x01;
    r[1] = seqCalibrating ? 0x04 : 0x03;
    sendReport(r);

    seqCalibrating = !seqCalibrating;
    seqBtn.textContent = seqCalibrating ? "Finish" : "Start calibration";
    hBtn.disabled = seqCalibrating;
}

/* ---------- Apply ---------- */
function applyConfig() {
    const r = new Uint8Array(64);
    r[0] = 0x02;
    r[1] = settings.cb1.checked ? 0x01 : 0x00;
    r[2] = settings.cb2.checked ? 0x01 : 0x00;
    r[3] = settings.cbSeq.checked ? 0x01 : 0x00;
    r[4] = settings.hAdj.value & 0xFF;
    r[6] = settings.seqAdj.value & 0xFF;
    r[8] = settings.cbPull.checked ? 0x01 : 0x00;
    sendReport(r);
}

/* ---------- Hooks ---------- */
document.getElementById("bindBtn").onclick = bindDevice;
hBtn.onclick = toggleHCalibration;
seqBtn.onclick = toggleSeqCalibration;
document.getElementById("applyBtn").onclick = applyConfig;

lockUI(true);
</script>

</body>
</html>